name: VPS Ubuntu 22.04 VM (16GB RAM, 4 Core, 32GB Disk)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Install QEMU & Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-kvm qemu-utils libvirt-daemon-system libvirt-clients bridge-utils virt-manager cloud-image-utils wget curl tmate

    - name: Download Ubuntu 22.04 Cloud Image
      run: |
        wget https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img -O ubuntu-22.04.img

    - name: Prepare VM Disk
      run: |
        qemu-img resize ubuntu-22.04.img 32G

    - name: Create Cloud-init Config (set root password)
      run: |
        cat > user-data <<EOF
        #cloud-config
        password: rizkykece
        chpasswd: { expire: False }
        ssh_pwauth: True
        EOF
        echo "instance-id: iid-local01\nlocal-hostname: ubuntu-vm" > meta-data
        cloud-localds seed.img user-data meta-data

    - name: Start VM with QEMU
      run: |
        nohup qemu-system-x86_64 \
          -m 16384 \
          -smp 4 \
          -drive file=ubuntu-22.04.img,if=virtio \
          -drive file=seed.img,if=virtio \
          -net nic -net user,hostfwd=tcp::2222-:22 \
          -nographic > vm.log 2>&1 &

    - name: Wait for Boot
      run: sleep 60

    - name: Start SSH Session (tmate)
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: false
        
